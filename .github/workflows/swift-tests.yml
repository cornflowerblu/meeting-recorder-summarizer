name: Swift Tests

on:
  pull_request:
    branches: [main]
    paths:
      - "macos/**"
      - ".github/workflows/swift-tests.yml"
  push:
    branches: [main]
    paths:
      - "macos/**"
      - ".github/workflows/swift-tests.yml"

jobs:
  test:
    name: Run Swift Tests
    runs-on: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.1"

      - name: Swift Version
        run: swift --version

      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-xcode-spm-

      - name: Run Tests
        working-directory: macos/InterviewCompanion
        timeout-minutes: 10
        run: |
          xcodebuild test \
            -project InterviewCompanion.xcodeproj \
            -scheme InterviewCompanion \
            -destination 'platform=macOS,arch=x86_64' \
            -skip-testing:InterviewCompanionUITests \
            CODE_SIGN_IDENTITY="-"        

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            macos/InterviewCompanion/test-output.txt
          retention-days: 30

  lint:
    name: SwiftLint
    runs-on: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        working-directory: macos
        run: |
          swiftlint --reporter github-actions-logging || true
          swiftlint > swiftlint-results.txt || true

      - name: SwiftLint Summary
        if: always()
        working-directory: macos
        run: |
          echo "## SwiftLint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -s swiftlint-results.txt ]; then
            VIOLATIONS=$(wc -l < swiftlint-results.txt | tr -d ' ')
            if [ "$VIOLATIONS" -eq 0 ]; then
              echo "✅ **No violations found**" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ **$VIOLATIONS violations found**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '<details>' >> $GITHUB_STEP_SUMMARY
              echo '<summary>View violations</summary>' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              head -50 swiftlint-results.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo '</details>' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "✅ **No violations found**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload SwiftLint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swiftlint-results
          path: macos/swiftlint-results.txt
          retention-days: 30

  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "❌ Tests failed or were cancelled"
            exit 1
          fi

          echo "✅ All checks passed"