name: Build macOS App

on:
  workflow_call:
    inputs:
      configuration:
        description: 'Build configuration (Debug or Release)'
        required: false
        type: string
        default: 'Debug'
      xcode-version:
        description: 'Xcode version to use'
        required: false
        type: string
        default: '16.1'

jobs:
  build:
    name: Build (${{ inputs.configuration }})
    runs-on: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ inputs.xcode-version }}

      - name: Swift Version
        run: swift --version

      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-xcode-spm-

      - name: Build
        working-directory: macos/InterviewCompanion
        timeout-minutes: 20
        run: |
          echo "=== Resolving SPM Dependencies ==="
          xcodebuild -resolvePackageDependencies -project InterviewCompanion.xcodeproj -scheme InterviewCompanion
          echo ""
          echo "=== Building InterviewCompanion ==="
          xcodebuild -scheme InterviewCompanion \
            -project InterviewCompanion.xcodeproj \
            -destination 'platform=macOS' \
            -configuration ${{ inputs.configuration }} \
            clean build \
            2>&1 | tail -100